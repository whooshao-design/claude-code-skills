# 4 角色详细检查清单

## Role 1: Correctness Reviewer

### 事务正确性
- [ ] `@Transactional` 注解位置正确（Service 层，非 private 方法）
- [ ] rollbackFor 是否指定了正确的异常类型
- [ ] propagation 是否合理（REQUIRED vs REQUIRES_NEW）
- [ ] 事务范围是否最小化（避免长事务）
- [ ] 嵌套事务是否有正确的传播行为

### MQ 消费幂等
- [ ] 消费者是否有 messageId/bizKey 去重机制
- [ ] ack/commit 时序是否正确（处理完成后才 ack）
- [ ] 消费失败是否有重试策略
- [ ] 重试次数是否有上限
- [ ] 是否有 DLQ（死信队列）兜底

### 缓存一致性
- [ ] DB write + cache invalidate 顺序是否正确
- [ ] 是否有缓存穿透/击穿/雪崩防护
- [ ] TTL 设置是否合理
- [ ] 缓存 Key 设计是否包含版本号/租户隔离
- [ ] 批量操作是否考虑缓存一致性

### 并发与锁
- [ ] 先查后改是否有竞态条件（Race Condition）
- [ ] 乐观锁 version 字段是否正确使用
- [ ] 分布式锁：锁超时/锁续期/锁释放是否完整
- [ ] CAS 操作是否有 ABA 问题
- [ ] 共享状态是否有线程安全保障
- [ ] 锁粒度是否最小化

### 查询正确性
- [ ] 是否有循环内 DB/RPC 调用（N+1 问题）
- [ ] 分页查询是否稳定（ORDER BY + 唯一字段）
- [ ] 大结果集是否有分页/流式处理
- [ ] 查询条件是否命中索引

### 异常处理与重试
- [ ] 是否有 catch 后静默吞掉异常
- [ ] 重试是否幂等安全
- [ ] 资源是否在 finally 中释放
- [ ] 异常信息是否包含足够上下文

### 状态机完整性（如涉及）
- [ ] 状态流转是否覆盖所有业务场景
- [ ] 是否存在孤立状态（无法到达终态）
- [ ] 异常中断后能否从当前状态恢复
- [ ] 状态变更是否有原子性保证
- [ ] 是否有异常状态监控/告警

---

## Role 2: Architecture Reviewer

### 分层与边界
- [ ] 是否符合现有架构分层（Controller → Service → Repository）
- [ ] 是否有跨层调用（如 Controller 直接调 DAO）
- [ ] 是否有循环依赖
- [ ] 模块边界是否清晰

### 配置外部化
- [ ] 超时时间是否可配置（非硬编码）
- [ ] 重试次数/间隔是否可配置
- [ ] 线程池大小是否可配置
- [ ] 开关/阈值是否通过配置中心管理

### 可测性
- [ ] 依赖是否通过注入（非 new/static）
- [ ] 外部依赖是否可 mock
- [ ] 方法职责是否单一（便于单元测试）

### 兼容性
- [ ] DTO 字段变更是否向后兼容
- [ ] 序列化格式是否兼容（JSON/Protobuf）
- [ ] 接口签名变更是否兼容
- [ ] DB schema 变更是否兼容（见 DDL 检查）

### 可读性
- [ ] 方法长度是否超过 80 行
- [ ] 圈复杂度是否过高（> 10）
- [ ] 命名是否清晰表达业务含义
- [ ] 魔法值是否定义为常量

---

## Role 3: Security Reviewer

### 注入攻击
- [ ] SQL 是否使用参数化查询（非字符串拼接）
- [ ] MyBatis XML 中是否使用 `${}` 拼接（应使用 `#{}`）
- [ ] 是否有 LDAP/XPath/OS 命令注入风险

### 敏感数据
- [ ] 日志中是否打印 PII（身份证、手机号、银行卡）
- [ ] 日志中是否打印 token/密钥/密码
- [ ] 敏感数据传输是否加密
- [ ] 敏感数据存储是否脱敏

### 反序列化
- [ ] 是否使用不安全的反序列化（如 Java ObjectInputStream）
- [ ] JSON 反序列化是否限制类型

### Redis 安全
- [ ] Redis key 是否有租户/环境隔离前缀
- [ ] Key 是否可被猜测（避免使用自增 ID）
- [ ] 是否有 Key 过期策略

### 鉴权（如涉及接口变更）
- [ ] 新接口是否有权限校验
- [ ] 是否有越权访问风险（水平/垂直越权）
- [ ] 敏感操作是否有审计日志

---

## Role 4: SRE/Reliability Reviewer

### 超时设置
- [ ] DB 连接/查询是否有超时
- [ ] Redis 操作是否有超时
- [ ] MQ 生产/消费是否有超时
- [ ] HTTP/RPC 调用是否有超时
- [ ] 超时值是否合理（非过大/过小）

### 重试与退避
- [ ] 重试是否有指数退避
- [ ] 重试次数是否有上限
- [ ] 重试是否幂等安全
- [ ] 是否有熔断/降级机制

### 资源管理
- [ ] 连接池配置是否合理
- [ ] 线程池是否有界
- [ ] 是否有背压机制（防止 OOM）
- [ ] 资源是否正确释放（连接、流、锁）

### 可观测性
- [ ] 关键操作是否有 traceId 传递
- [ ] 业务关键字段是否在日志中（bizKey/messageId）
- [ ] 是否有关键 metrics（成功率、RT、QPS）
- [ ] 异常是否有告警配置

### 埋点完整性
- [ ] 核心业务入口：sumReport
- [ ] 关键分支决策：counterReport
- [ ] 耗时操作：averageReport
- [ ] 异常处理：errorReport
- [ ] 埋点参数完整（业务标识、场景、结果码）

### 放量设计
- [ ] 新功能是否有开关控制
- [ ] 开关默认值是否安全（默认关闭）
- [ ] 是否支持灰度放量（百分比/白名单）
- [ ] 配置变更是否需要重启
