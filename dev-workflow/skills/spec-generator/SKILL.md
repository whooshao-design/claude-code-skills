---
name: spec-generator
description: 技术方案与开发计划生成器。根据需求规格（req-spec.md）和代码分析，自动生成 tech-spec.md 和 dev-plan.md。使用条件：需求澄清完成后，或用户要求设计技术方案时触发。
version: 1.0.0
---
> **Skill**: spec-generator | **Version**: 1.0.0


# 方案设计系统

## 快速开始

**输入方式**：
- 引用需求文档：`@~/.claude/specs/{需求名称}/需求文档/req-spec.md`
- 直接提供需求内容
- 已有代码分析结果（可选）

**输出**：
- `tech-spec.md` - 技术方案文档
- `dev-plan.md` - 开发计划文档

## 目录约定

> **重要**：`.claude/specs/` 是**用户级目录**，位于 `~/.claude/specs/`（即 `/home/{user}/.claude/specs/`），**不是**当前项目目录下的 `.claude/specs/`。
>
> 所有 skill 产出的文档统一存放在此目录下，按需求名称组织。

---

## 工作流概览

```
req-spec.md → 代码分析 → tech-spec.md → dev-plan.md → 可选调用 tech-review
```

---

## Step 1: 输入处理与复杂度确认

**输入验证**（必须）：
1. 检查用户是否提供了 req-spec.md 路径或需求内容
2. 如果提供了路径 → 验证文件存在且非空
3. 如果文件不存在 → 提示用户先调用 `requirement-clarifier` 生成
4. 如果用户直接粘贴需求内容 → 接受并继续

**读取需求文档**：
- 读取用户指定的 `req-spec.md`
- 或读取用户提供的需求内容
- 提取关键信息：功能摘要、业务规则、输入输出、验收标准

**确认复杂度**（必须）：

使用 `AskUserQuestion` 询问：

```
Question: "确认技术方案复杂度：

| 复杂度 | 说明 | 模板详细程度 |
|--------|------|--------------|
| **Simple** | 单模块改动，影响范围小 | 精简 |
| **Medium** | 多模块改动，需要协调 | 标准 |
| **Complex** | 新系统/跨系统改造 | 详细 |

如不确定，选择 Medium。"
```

**Options**:
1. label: "Simple - 单模块改动"
2. label: "Medium - 多模块改动" (Recommended)
3. label: "Complex - 新系统/跨系统"

记录用户选择为 `${complexity}`（simple/medium/complex）

---

## Step 2: 代码分析

**自动分析以下内容**：

| 分析项 | 说明 |
|--------|------|
| **相关代码区域** | 将受影响或引用的目录/模块 |
| **现有模式** | 代码库中已有的可复用模式 |
| **技术栈** | 使用的框架、库、版本 |
| **依赖关系** | 模块间依赖、外部依赖 |

**代码分析命令**（如果需要）：

```bash
# 分析相关代码
find src -name "*.java" -type f | xargs grep -l "相关关键词"

# 查找类似实现
grep -r "类似功能" --include="*.java" .
```

---

## Step 3: 生成 tech-spec.md

**输出路径**：
```
~/.claude/specs/{需求名称}/技术方案/tech-spec.md
```

**生成策略**（根据复杂度）：

| 复杂度 | 模板章节 | 说明 |
|--------|----------|------|
| Simple | 基础章节 | 概述、方案设计、API、风险 |
| Medium | 标准章节 | + 数据模型、实现要点、测试策略 |
| Complex | 详细章节 | + 性能分析、安全设计、灰度方案 |

**tech-spec.md 模板结构**（参考 template-techspec.md）：

```markdown
# {功能名称} - 技术方案

## 1. 概述

### 1.1 功能摘要
[一句话描述]

### 1.2 需求参考
[关键需求点]

---

## 2. 技术上下文

### 2.1 技术栈
| 类别 | 技术 | 版本 |
|------|------|------|
| 语言 | Java | 8+ |
| 框架 | Spring | 5.x |

### 2.2 相关代码区域
[受影响或引用的目录]

### 2.3 现有模式识别
[可复用的模式]

---

## 3. 方案设计

### 3.1 方案对比（如有多个选项）

| 维度 | 方案 A | 方案 B |
|------|--------|--------|
| 优点 | | |
| 缺点 | | |
| 复杂度 | 低/中/高 | 低/中/高 |
| 风险 | 低/中/高 | 低/中/高 |

**选定方案**：[方案 X]
**选择理由**：[为什么选这个]

### 3.2 架构概览
[ASCII 图或组件描述]

### 3.3 API 设计

#### 接口：[HTTP 方法] /api/path
- **用途**：[做什么]
- **请求**：
  ```json
  {
    "field": "类型 - 描述"
  }
  ```
- **响应**：
  ```json
  {
    "field": "类型 - 描述"
  }
  ```

### 3.4 数据模型

#### 实体：[EntityName]
| 字段 | 类型 | 约束 | 描述 |
|------|------|------|------|

#### 数据库变更
- [ ] 新建表：[table_name]
- [ ] 修改表：[table_name]

---

## 4. 实现要点

### 4.1 需新建的类
| 类 | 职责 | 位置 |
|----|------|------|

### 4.2 需修改的类
| 类 | 修改内容 | 原因 |
|----|----------|------|

### 4.3 依赖项
[需要新增的依赖]

---

## 5. 风险评估

### 5.1 技术风险
| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|

### 5.2 假设条件
- 假设 1

### 5.3 待确认问题
- [ ] 问题 1

---

## 6. 测试策略

> **重要**：本节只描述测试方向和策略，不编写示例代码或 mock 代码。

### 6.1 单元测试
- **目标覆盖率**：≥90%
- **测试重点模块**：[列出需要重点测试的类/方法]
- **关键测试场景**：
  - [场景描述，如：正常流程、边界条件、异常处理]
  - [场景描述]
- **Mock 策略**：[说明哪些依赖需要 mock，为什么]

### 6.2 集成测试
- **测试边界**：[描述集成测试的范围边界]
- **关键集成点**：
  - [集成点描述，如：数据库交互、外部服务调用]
  - [集成点描述]
- **测试数据准备**：[描述测试数据的准备策略]

### 6.3 测试优先级
| 优先级 | 测试内容 | 理由 |
|--------|----------|------|
| P0 | [最关键的测试] | [为什么最重要] |
| P1 | [次要测试] | [理由] |

---

## 附录

### A. 代码分析摘要
[分析的关键发现]

### B. 参考资料
- [参考链接]
```

---

## Step 4: 生成 dev-plan.md

**输出路径**：
```
~/.claude/specs/{需求名称}/代码开发/dev-plan.md
```

**生成策略**（根据复杂度）：

| 复杂度 | 任务数量 | 粒度 |
|--------|----------|------|
| Simple | 2-3 个 | 粗粒度 |
| Medium | 3-5 个 | 标准 |
| Complex | 5-8 个 | 细粒度 |

**dev-plan.md 模板结构**（参考 template-devplan.md）：

```markdown
# {功能名称} - 开发计划

## Overview
[一句话描述核心功能]

## Technical Specification
> 详细技术方案请参阅：[tech-spec.md](../技术方案/tech-spec.md)

## Task Breakdown

### Task 1: [任务名称]
- **ID**: task-1
- **Description**: [描述]
- **File Scope**: [文件范围]
- **Dependencies**: [None / task-x]
- **Test Command**: [测试命令]
- **Test Focus**: [测试场景]

### Task 2: [任务名称]
...

(2-5 tasks)
```

### 任务拆分规则

1. **任务数量**：根据复杂度确定
   - Simple: 2-3 个
   - Medium: 3-5 个
   - Complex: 5-8 个

2. **每个任务必须包含 6 个必填字段**：
   - **ID**: 唯一标识（task-1, task-2, etc.）
   - **Description**: 具体描述
   - **File Scope**: 具体文件范围（非"所有文件"）
   - **Dependencies**: 依赖声明（None 或 task-x）
   - **Test Command**: 完整测试命令（含覆盖率参数）
   - **Test Focus**: 测试关注点（只描述场景方向）

3. **任务独立性**：尽可能设计独立任务以支持并行执行

4. **覆盖率要求**：验收标准始终要求 ≥90% 代码覆盖率

---

## Step 5: 方案确认与迭代

**展示方案摘要**，使用 `AskUserQuestion` 询问：

- Question: "技术方案和开发计划已生成，是否需要调整？"
- Options: "确认，进入评审" / "需要调整"

**如需调整**：
1. 收集用户反馈（具体调整点）
2. 基于反馈重新执行 Step 2-4 中受影响的部分
3. 更新文档，保留调整记录
4. 重新确认（最多迭代 3 轮）

---

## Step 6: 生成后处理

**技术方案评审入口**：

```
技术方案已生成：
- tech-spec.md：[路径]
- dev-plan.md：[路径]

是否需要调用方案评审系统进行评审？
```

**用户确认**：
- `/review-now` → 调用 tech-review Skill
- `/review-later` → 暂不评审，流程结束

---

## 用户指令

| 指令 | 说明 |
|------|------|
| `/plan-stop` | 终止方案设计 |
| `/plan-status` | 查看当前进度 |
| `/review-now` | 立即开始方案评审 |
| `/review-later` | 暂不评审 |

---

## 错误处理机制

如果输入上下文不完整或不清楚：

1. **明确请求缺失的信息**
2. **不要继续生成低质量文档**
3. **不要编造分析中未发现的技术细节**
4. **询问以下内容的澄清**：技术栈细节、不清楚的模式、模糊的需求

**示例**：
```
发现以下信息缺失：
- req-spec.md 中缺少输入输出定义
- 代码分析未找到相关模块

请提供以上信息后再继续生成方案。
```

---

## 与其他 Skill 的关系

| Skill | 输入 | 输出 | 关系 |
|-------|------|------|------|
| **requirement-clarifier** | 原始需求 | req-spec.md | 前置输入（上游） |
| **tech-review** | tech-spec.md | Review-vX.md | 可选下游（方案评审） |
| **code-dev** | dev-plan.md | 代码 + 测试 | 直接下游（开发执行） |
| **dev-cr** | git diff | CR Report | 间接下游（开发完成后） |

---

## 输出文件位置汇总

```
~/.claude/specs/{需求名称}/
├── 需求文档/
│   └── req-spec.md          ← 需求澄清产出
├── 技术方案/
│   ├── tech-spec.md         ← 方案设计产出
│   └── review/
│       └── Review-vX.md     ← 方案评审产出
├── 代码开发/
│   ├── dev-plan.md          ← 开发计划产出
│   └── review/
│       └── Review-xxx.md    ← 代码评审产出
└── 测试验证/
    └── test-report-YYYYMMDD.md  ← 测试验证产出
```

---

## 质量检查

### tech-spec.md 生成前检查

- [ ] 所有 6 个主要章节都填写了具体内容
- [ ] 技术栈与实际项目技术匹配
- [ ] 文件路径引用代码库中的真实位置
- [ ] 现有模式有示例说明（非模糊描述）
- [ ] API 设计包含请求/响应格式（如适用）
- [ ] 数据模型变更是明确的（如适用）
- [ ] 风险和假设已识别
- [ ] 测试策略描述方向和场景，不含示例代码

### dev-plan.md 生成前检查

- [ ] 任务数量在合理范围（Simple: 2-3, Medium: 3-5, Complex: 5-8）
- [ ] 每个任务包含全部 6 个必填字段
- [ ] 测试命令包含覆盖率参数
- [ ] 依赖关系明确声明
- [ ] 验收标准包含 90% 覆盖率要求
- [ ] 文件范围具体（非"所有文件"这种模糊描述）
- [ ] 测试关注点描述场景方向，不含示例代码

---

## 关键约束

- **仅生成文档**：只生成文档，不执行代码、运行测试或修改源文件
- **双文件输出**：产出两个文件，按顺序生成
- **路径准确**：
  - 第一个文件：`~/.claude/specs/{需求名称}/技术方案/tech-spec.md`
  - 第二个文件：`~/.claude/specs/{需求名称}/代码开发/dev-plan.md`
- **语言匹配**：输出语言与用户输入匹配
- **上下文复用**：生成 dev-plan.md 时，直接引用已生成的 tech-spec.md 内容
- **基于证据**：所有技术细节必须来自代码分析，而非假设
