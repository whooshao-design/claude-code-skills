---
description: 需求澄清与规格化。将模糊需求转化为结构化的 req-spec.md，支持用户描述、文件导入、TAPD/JIRA 链接抓取。使用条件：用户需求不清晰、需要结构化需求文档时自动触发。
---

# 需求澄清系统

## 快速开始

**输入方式**（任选其一）：
- 用户描述："帮我做个额度冻结功能"
- 读取文件：`@docs/需求/原始需求.md`
- TAPD 链接：提供 TAPD 故事链接自动抓取
- 混合方式：先读取文件，再口头补充

**输出**：`req-spec.md`（保存在 `~/.claude/specs/{需求名称}/需求文档/` 目录）

## 目录约定

> **重要**：`.claude/specs/` 是**用户级目录**，位于 `~/.claude/specs/`（即 `/home/{user}/.claude/specs/`），**不是**当前项目目录下的 `.claude/specs/`。
>
> 所有 skill 产出的文档统一存放在此目录下，按需求名称组织。

---

## 澄清工作流

```
需求输入 → 初步理解确认 → 5W1H 提问 → 边界确认 → 输出 req-spec.md
                                                    ↓
                                              用户确认 / 修订
```

---

## Step 1: 需求输入与识别

**读取需求内容**：
- 优先读取用户指定的文件
- 如用户提供口头描述，记录要点
- 如提供 TAPD 链接，调用 TAPD 抓取工具

**TAPD 集成**（如提供链接）：

参考 `scripts/tapd_fetcher.py`：
```bash
# 提取 TAPD 故事信息
python scripts/tapd_fetcher.py <TAPD_URL>
```

**初步理解确认**：
- 用一句话复述需求，问用户"我理解的对吗？"
- 确认后进入 5W1H 提问阶段

---

## Step 2: 5W1H 聚焦式提问

**沟通风格**（参考 dev-plan）：
- **结构化提问**：每次聚焦一个维度
- **假设确认**："我理解...对吗？"
- **推荐标注**：选项后标注推荐原因

### 提问顺序（建议）

| 顺序 | 维度 | 核心问题 | 产出 |
|------|------|----------|------|
| 1 | What | 这个功能要解决什么问题？做什么？ | 功能摘要 |
| 2 | Why | 为什么现在要做？有什么价值？ | 业务背景 |
| 3 | Who | 谁触发？谁使用？谁受益？ | 用户角色 |
| 4 | When | 何时触发？实时还是异步？ | 触发时机 |
| 5 | Where | 什么场景下使用？前置条件？ | 适用场景 |
| 6 | How | 期望怎么做？有什么限制？ | 业务规则 |

### 每轮提问模板

**示例 - What 维度**：

```
我理解这个功能是要实现[复述用户需求]。

请问：
1. 这个功能主要解决什么问题？
2. 成功的标志是什么？（什么样的结果算完成）
3. 有没有参考的现有功能？
```

**示例 - How 维度**：

```
关于实现方式，请确认：
1. 输入是什么？必填字段有哪些？
2. 输出是什么？返回给谁？
3. 有什么约束条件？（金额限制、频率限制等）
4. 有什么例外情况要处理？
```

---

## Step 3: 边界确认

**包含范围**：
```
请问这个功能需要包含哪些具体能力？
（列出用户确认的点）
```

**不包含范围**（重要）：
```
哪些不在本次范围内？（后续迭代/其他人负责）
```

**识别依赖**：
- 上游依赖：谁提供数据？
- 下游依赖：调用谁的服务？
- 外部依赖：第三方系统？

---

## Step 4: 验收标准

**功能验收点**：
```
请给出功能验收标准，格式如：
- [ ] 用户冻结成功后返回冻结单号
- [ ] 冻结金额不能超过可用额度
- [ ] 并发冻结只允许一笔成功
```

**非功能要求**：
- 性能要求：RT < X ms
- 可用性要求：成功率 > 99.9%
- 监控要求：需要哪些埋点/告警

---

## Step 5: 输出 req-spec.md

**输出文件**：
- 路径：`~/.claude/specs/{需求名称}/需求文档/req-spec.md`
- 示例：`~/.claude/specs/额度冻结功能/需求文档/req-spec.md`
- 文件名固定，不可自定义

**文件格式**（参考 template.md）：

```markdown
# {功能名称} - 需求规格说明书

## 1. 概述

### 1.1 功能摘要
[一句话描述]

### 1.2 业务背景
[为什么做]

### 1.3 需求来源
- 来源：用户描述 / TAPD #12345 / ...
- 优先级：P0 / P1 / P2

---

## 2. 功能范围

### 2.1 包含范围
- [ ] 能力1
- [ ] 能力2

### 2.2 不包含范围
- [ ] 不做1
- [ ] 不做2

---

## 3. 业务规则

### 3.1 业务流程
[步骤描述或 ASCII 图]

### 3.2 业务规则
| 规则 | 描述 | 优先级 |
|------|------|--------|
| R-1 | xxx | P0 |

### 3.3 状态定义
| 状态 | 说明 |
|------|------|
| INIT | 初始状态 |

---

## 4. 输入输出

### 4.1 输入
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|

### 4.2 输出
| 字段 | 类型 | 说明 |
|------|------|------|

---

## 5. 约束与假设

### 5.1 性能要求
- RT < X ms

### 5.2 限制条件
- 单笔最大金额：Xxx

### 5.3 假设
- 假设1

---

## 6. 异常场景

| 场景 | 处理方式 | 优先级 |
|------|----------|--------|
| 余额不足 | 返回错误码 | P0 |

---

## 7. 可观测性

### 7.1 监控指标
- 成功率
- 平均耗时

### 7.2 埋点需求
- 入口埋点
- 决策埋点

### 7.3 告警规则
- 成功率 < 99% 告警

---

## 8. 验收标准

### 8.1 功能验收
- [ ] 验收点1

### 8.2 非功能验收
- [ ] RT < 100ms

---

## 9. 开放问题

| ID | 问题 | 待确认方 |
|----|------|----------|
| Q-1 | xxx | 产品 |

---

## 附录

### A. 参考资料
- 链接1

### B. 术语表
| 术语 | 定义 |
|------|------|
```

---

## 用户确认与修订

**输出后等待用户确认**：

```
需求规格说明书已生成：[req-spec.md 路径]

请确认：
1. 以上内容是否准确反映您的需求？
2. 是否有遗漏或需要修改的地方？

回复"确认"开始方案设计，或提出修改意见。
```

**修订处理**：
- 用户提出修改意见 → 更新 req-spec.md
- 用户确认 → 需求澄清完成

---

## 用户指令

| 指令 | 说明 |
|------|------|
| `/req-stop` | 终止需求澄清 |
| `/req-status` | 查看当前澄清状态 |
| `/req-output <路径>` | 指定输出路径 |

---

## 与其他 Skill 的关系

| Skill | 关系 | 触发方式 |
|-------|------|----------|
| **spec-generator** | req-spec.md 是直接下游输入 → 生成 tech-spec.md + dev-plan.md | 澄清完成后建议用户调用 |
| **tech-review** | 技术方案生成后可调用评审 | 间接关联（经 spec-generator） |
| **code-dev** | dev-plan.md 是开发输入 | 间接关联（经 spec-generator） |
| **dev-cr** | 开发完成后调用代码评审 | 间接关联（经 code-dev） |

---

## 沟通原则

### 下一步建议

req-spec.md 生成完成后，向用户提示：

- 如需生成技术方案和开发计划 → 调用 `spec-generator`，传入 `@~/.claude/specs/{需求名称}/需求文档/req-spec.md`
- 如需直接开发 → 调用 `code-dev`（但建议先生成方案）

### DO（应该做）
- ✅ 每次问一个问题，避免信息过载
- ✅ 复述确认："我理解...对吗？"
- ✅ 对模糊点追问直到清晰
- ✅ 主动识别隐含假设

### DON'T（不要做）
- ❌ 不要一次问所有问题
- ❌ 不要假设用户已知晓所有边界
- ❌ 不要跳过"不包含范围"的确认
- ❌ 不要急于给技术方案

---

## 常见问题处理

### 问题1：用户描述太模糊

```
用户：帮我做个额度冻结

处理：
1. 复述：我理解您需要一个额度冻结功能
2. 追问：请问这个功能是给谁用的？（C端用户/B端运营）
3. 追问：冻结后需要做什么？（仅冻结/还要解冻/还要扣减）
```

### 问题2：用户前后说法不一致

```
处理：
1. 记录两种说法
2. 明确指出矛盾点
3. 请用户确认最终意图
```

### 问题3：超出技术范围的问题

```
处理：
1. 记录问题到"开放问题"章节
2. 标注"待产品/业务确认"
3. 继续澄清可明确的部分
```
