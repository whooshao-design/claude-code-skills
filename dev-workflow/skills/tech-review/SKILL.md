---
name: tech-review
description: AI驱动的技术方案自动化评审系统。执行结构化、分轮次、多视角的方案评审，输出标准化的 Review-vX.md 文档。使用条件：Claude 需要对技术方案进行系统性评审时，自动进入评审流程。支持读取文件或粘贴方案内容作为输入。
version: 1.1.0
---

# 技术方案评审系统

## 快速开始

**输入方式**（任选其一）：
- 读取文件：`@docs/技术方案.md`
- 粘贴内容：直接将方案内容粘贴到对话中
- 混合方式：先读取文件，再补充说明

评审粒度会在评审开始前询问用户选择。

## 目录约定

> **重要**：`.claude/specs/` 是**用户级目录**，位于 `~/.claude/specs/`（即 `/home/{user}/.claude/specs/`），**不是**当前项目目录下的 `.claude/specs/`。
>
> 所有 skill 产出的文档统一存放在此目录下，按需求名称组织。

---

## 评审流程概览

```
方案输入 → 自动识别方案结构 → 分轮评审 → 输出 Review-vX.md → 自动收敛检测
                                              ↓
                                        Checkpoint? ──是──→ 暂停等待人工
                                              ↓否
                                        继续下一轮 / 终止
```

---

## 核心评审维度（Standard 粒度）

每轮评审覆盖以下维度，Deep 粒度会增加更多专项检查：

### 1. 系统边界与目标清晰度
- 方案目标是否明确、可度量
- 系统边界是否清晰
- 上下游依赖是否完整列出

### 2. 核心流程与状态模型
- 主流程是否完整
- 状态机是否覆盖所有分支
- 异常流程是否完整

### 3. 异常路径与失败模式
- 异常场景是否穷尽
- 降级策略是否合理
- 失败恢复机制

### 4. 并发与一致性
- 并发场景是否识别
- 分布式事务边界
- 幂等设计

### 5. 实现复杂度与人力假设
- 工时估算是否合理
- 技术难度是否被低估
- 是否有过度工程

### 6. 运维与回滚
- 监控指标是否完整
- 回滚方案是否可行
- 灰度策略

### 7. 表达与完整性
- 关键定义是否清晰
- 是否有歧义表述
- 是否有遗漏章节

---

## 问题分级体系

| 级别 | 标记 | 说明 | 处理要求 |
|------|------|------|----------|
| **Blocker** | 🔴 B-x | 方案根本性缺陷，无法通过 | 必须修复，否则不上线 |
| **Major** | 🟠 M-x | 重大风险或遗漏 | 强烈建议修复 |
| **Completeness** | 🟡 C-x | 完整性建议 | 建议补充 |
| **Risk** | 🟣 R-x | 已识别风险 | 可接受风险 |
| **Question** | 🔵 Q-x | 待确认问题 | 需要人工确认 |

---

## 评审文档结构

每轮输出 `Review-vX.md`，结构固定：

```markdown
# 技术方案评审报告 v{X}

## 评审元信息
- **评审轮次**: v{X}
- **评审粒度**: {quick/standard/deep}
- **方案版本**: {vX.X}
- **评审时间**: {YYYY-MM-DD HH:mm:ss}
- **收敛状态**: {收敛中 / 已收敛 / Checkpoint 暂停}

---

## 本轮评审结论
### 核心发现
[本轮发现的关键问题概述]

### 收敛性评估
- **新增问题**: {B:M:C:R:Q} = {数量}
- **问题存量**: {总数}
- **收敛趋势**: ↑ 上升 / → 持平 / ↓ 下降

---

## 问题总览（状态追踪）

| ID | 级别 | 问题标题 | 首现轮次 | 当前状态 | 状态变更 |
|----|------|----------|----------|----------|----------|
| B-1 | 🔴 | 目标不清晰 | v1 | Open | New |
| M-1 | 🟠 | 缺少幂等设计 | v2 | Open | New |
```

---

## 问题详细记录

### 🔴 Blocker（必须修复）

#### [B-{id}] {问题标题}
- **首次发现**: v{轮次}
- **问题描述**: {客观描述}
- **影响范围**: {方案层面 / 业务层面}
- **修复建议**: {具体可操作的建议}
- **验证说明**: {上下游分析结论}

---

### 🟠 Major（强烈建议修复）

#### [M-{id}] {问题标题}
...

---

### 🟡 Completeness（建议补充）

#### [C-{id}] {问题标题}
...

---

### 🟣 Accepted Risk（已接受风险）

#### [R-{id}] {风险标题}
...

---

### 🔵 Open Questions（待确认问题）

#### [Q-{id}] {问题标题}
- **问题描述**: {客观描述}
- **依赖事实**: {需要确认的信息}
- **无法确认原因**: {穷尽验证后的结论}
- **Checkpoint**: {是 / 否}

---

## 评审收敛性自检

### 终止条件检查
- [ ] 连续 2 轮无新增 Blocker/Major
- [ ] 所有 Blocker 已 Resolved
- [ ] 达到最大轮次

### 收敛建议
{基于问题趋势的建议}

---

## 附录

### 评审历史
| 轮次 | Blocker | Major | Completeness | Risk | Question |
|------|---------|-------|--------------|------|----------|
| v1   | 2       | 3     | 5            | 0    | 1        |
| v2   | 1       | 2     | 4            | 1    | 1        |
```

---

## 评审工作流

### Step 1: 方案输入与识别 + 粒度选择

**读取方案内容**：
- 优先读取用户指定的文件
- 如用户提供粘贴内容，直接使用
- 自动识别方案结构（章节、API、数据模型等）

**选择评审粒度**（必须）：

使用 `AskUserQuestion` 询问用户：

```
Question: "选择技术方案评审粒度：

| 粒度 | 说明 | 轮次 |
|------|------|------|
| **Quick** | 仅 Blocker + Major 检查 | 3 轮 |
| **Standard** | Blocker + Major + Completeness | 8 轮 |
| **Deep** | 全维度深度评审 | 16 轮 |

如不确定，选择 Standard 即可。"

Options:
1. label: "Quick (3轮)"
2. label: "Standard (8轮)" (Recommended)
3. label: "Deep (16轮)"
```

记录用户选择为 `${review_depth}`（quick/standard/deep），然后继续评审。

**快速结构扫描**：
```
方案结构检查清单：
[ ] 概述/背景
[ ] 目标/范围
[ ] 方案设计
[ ] 核心流程
[ ] 异常处理
[ ] 风险评估
```

### Step 2: 分轮评审

**Quick 粒度（3 轮）**：
- v1: 系统边界 + 目标清晰度
- v2: 核心流程 + 异常路径
- v3: 收敛 + 风险声明

**Standard 粒度（8 轮）**：
- v1: 系统边界 + 目标清晰度
- v2: 核心流程 + 状态模型
- v3: 异常路径 + 失败模式
- v4: 并发 + 一致性
- v5: 实现复杂度 + 人力假设
- v6: 运维 + 回滚
- v7: 表达 + 完整性
- v8: 收敛 + 风险声明

**Deep 粒度（16 轮）**：在 Standard 基础上增加：
- v9: 性能专项 → 缓存策略、DB 查询优化、并发性能、RT 预估
- v10: 安全专项 → 注入风险、越权、敏感数据、加密传输
- v11: 数据迁移专项 → 兼容性、回滚方案、数据校验
- v12: 灰度放量专项 → 开关设计、放量策略、回滚机制
- v13: 监控告警专项 → 指标完整性、告警阈值、SLA 保障
- v14: 文档完备性 → API 文档、配置说明、运维手册
- v15: 历史一致性 → 与已上线系统的兼容、接口版本演进
- v16: 边界条件 → 极端输入、资源耗尽、超时场景

### Step 3: 问题验证（防误报）

**验证原则**：
- 优先从方案内容、代码库中寻找答案
- 基于明确技术常识验证
- 穷尽所有路径仍无法确认 → Open Question

**验证检查清单**：
- [ ] 上游是否已处理该场景
- [ ] 下游是否有保障机制
- [ ] 业务场景是否可达
- [ ] 是否有配置/注释说明是有意设计

### Step 4: 输出与收敛

**输出文件**（根据输入来源自动选择路径）：

**模式 A：统一目录**（方案来自 `~/.claude/specs/` 工作流）：
- 路径：`~/.claude/specs/{需求名称}/技术方案/review/Review-v{X}.md`
- 示例：`~/.claude/specs/额度冻结功能/技术方案/review/Review-v1.md`

**模式 B：就近输出**（方案来自项目本地目录）：
- 路径：`{方案所在目录}/review/Review-v{X}.md`
- 示例：`docs/需求开发/决策接口路由缓存优化需求/技术方案/review/Review-v1.md`

**路径选择规则**：
1. 如果输入文件在 `~/.claude/specs/` 下 → 模式 A
2. 如果输入文件在项目目录下 → 模式 B
3. 如果是粘贴内容 → 使用 `AskUserQuestion` 询问输出位置
4. 文件名固定为 `Review-v{X}.md`，不可自定义

**收敛判断**：
- 连续 2 轮无新增 Blocker/Major → 建议终止
- 所有 Blocker 已 Resolved，且 Open Question 数量 ≤ 2 → 建议终止
- 所有问题均为 Resolved/Risk → 强制终止
- 达到最大轮次 → 强制终止
- Open Question 处理规则：超过 3 轮未解决的 Question 自动降级为 Risk（已接受风险）

---

## Checkpoint 机制

### 触发条件（满足任一）

1. **Open Question 无法降级**：
   - 方案正文无答案
   - 代码库无明确依据
   - 技术常识无法验证
   - 多个解释互相矛盾

2. **核心前提矛盾**：
   - 方案不同章节出现矛盾
   - 与已上线系统假设冲突

3. **依赖事实无法验证**：
   - 依赖外部系统能力，但无法确认
   - 依赖第三方文档，但文档缺失

### Checkpoint 限制（防止无限循环）

- 同一 Question 最多 Checkpoint **2 次**，第 3 次自动降级为 Risk（已接受风险）
- 整个评审过程最多触发 **3 次** Checkpoint
- 超过限制后，未解决的 Question 统一标记为 Risk 并继续评审

### 触发后处理

```
Checkpoint 触发
    ↓
输出 Review-vX.md（含 Checkpoint 标记）
    ↓
暂停评审流程
    ↓
等待人工输入：
- /review-continue <结论>    → 基于人工结论继续评审
- /review-accept <Q-id>     → 接受某 Question，不再追问
- /review-resolve <Q-id>   → 确认答案，解决问题
- /review-stop              → 终止评审
```

---

## 用户指令

| 指令 | 说明 |
|------|------|
| `/review-stop` | 立即终止评审 |
| `/review-status` | 查看当前评审状态 |
| `/review-force <轮次>` | 跳转到指定轮次（仅限收敛后继续） |

> **提示**：评审粒度在开始前选择，Checkpoint 时可通过以下方式继续：
> - 直接提供结论 → `/review-continue <结论>`
> - 接受某 Question → `/review-accept <Q-id>`
> - 确认答案 → `/review-resolve <Q-id>`

---

## 输出位置

评审文档保存位置取决于输入来源：

### 模式 A：统一目录（`~/.claude/specs/` 工作流）

```
~/.claude/specs/{需求名称}/
├── 需求文档/
│   └── req-spec.md          ← 需求澄清产出
├── 技术方案/
│   ├── tech-spec.md         ← 方案设计产出
│   └── review/
│       ├── Review-v1.md     ← 评审产出
│       └── Review-v2.md
├── 代码开发/
│   ├── dev-plan.md          ← 开发计划产出
│   └── review/
│       └── Review-xxx.md    ← 代码评审产出
└── 测试验证/
    └── test-report-YYYYMMDD.md  ← 测试验证产出
```

### 模式 B：就近输出（项目本地目录）

```
{方案所在目录}/
├── 技术方案.md              ← 被评审的方案
└── review/
    ├── Review-v1.md         ← 评审产出
    └── Review-v2.md
```

---

## 与其他 Skill 的关系

| Skill | 关系 | 触发方式 |
|-------|------|----------|
| **requirement-clarifier** | req-spec.md 可作为评审参考 | 间接关联 |
| **spec-generator** | tech-spec.md 是直接评审输入 | 方案生成后调用 |
| **code-dev** | 评审通过后才开始开发 | 评审完成后建议调用 |
| **dev-cr** | 代码评审在后 | 间接关联（经 code-dev） |

---

## 与代码审查的区别

| 维度 | 代码审查 (dev-cr) | 技术方案评审 |
|------|-------------------|--------------|
| **对象** | 源代码变更 | 技术方案文档 |
| **粒度** | 行级/方法级 | 模块级/系统级 |
| **分级** | P0/P1/P2 | Blocker/Major/Completeness/Risk/Question |
| **验证** | 上下游代码分析 | 方案一致性/技术常识 |
| **输出** | CR Report | Review-vX.md |
| **收敛** | 问题验证通过即关闭 | 多轮收敛检测 |

---

## 过度工程审查原则

**警惕过度设计**，这与技术评审同等重要：

| ❌ 过度工程 | ✅ 恰当实现 |
|-------------|-------------|
| 为假设的未来需求预留扩展 | 只实现当前需求 |
| 一次性逻辑抽象成工具类 | 内联实现 |
| 添加未请求的"优化" | 按需实现 |
| 过早抽象（仅一处使用） | 必要时再抽象 |

**遇到以下情况，标记为 Completeness**：
- 为不可能发生的场景添加复杂处理
- 添加冗余的配置项
- 创建只用一次的抽象
